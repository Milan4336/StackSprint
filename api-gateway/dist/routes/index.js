"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.router = void 0;
const express_1 = require("express");
const TransactionRepository_1 = require("../repositories/TransactionRepository");
const CaseRepository_1 = require("../repositories/CaseRepository");
const RuleEngineService_1 = require("../services/RuleEngineService");
const MlServiceClient_1 = require("../services/MlServiceClient");
const FraudScoringService_1 = require("../services/FraudScoringService");
const TransactionService_1 = require("../services/TransactionService");
const EventBusService_1 = require("../services/EventBusService");
const TransactionController_1 = require("../controllers/TransactionController");
const AuthController_1 = require("../controllers/AuthController");
const SimulationController_1 = require("../controllers/SimulationController");
const MonitoringController_1 = require("../controllers/MonitoringController");
const CaseController_1 = require("../controllers/CaseController");
const AuditController_1 = require("../controllers/AuditController");
const SystemController_1 = require("../controllers/SystemController");
const ModelController_1 = require("../controllers/ModelController");
const SettingsController_1 = require("../controllers/SettingsController");
const SearchController_1 = require("../controllers/SearchController");
const UserRepository_1 = require("../repositories/UserRepository");
const FraudAlertRepository_1 = require("../repositories/FraudAlertRepository");
const UserDeviceRepository_1 = require("../repositories/UserDeviceRepository");
const FraudExplanationRepository_1 = require("../repositories/FraudExplanationRepository");
const AuditLogRepository_1 = require("../repositories/AuditLogRepository");
const ModelMetricRepository_1 = require("../repositories/ModelMetricRepository");
const SystemSettingRepository_1 = require("../repositories/SystemSettingRepository");
const UserRiskProfileRepository_1 = require("../repositories/UserRiskProfileRepository");
const AuthService_1 = require("../services/AuthService");
const AutonomousResponseService_1 = require("../services/AutonomousResponseService");
const DeviceFingerprintService_1 = require("../services/DeviceFingerprintService");
const FraudExplanationService_1 = require("../services/FraudExplanationService");
const SimulationService_1 = require("../services/SimulationService");
const GeoService_1 = require("../services/GeoService");
const AuditService_1 = require("../services/AuditService");
const CaseService_1 = require("../services/CaseService");
const SettingsService_1 = require("../services/SettingsService");
const ModelMetricsService_1 = require("../services/ModelMetricsService");
const SystemHealthService_1 = require("../services/SystemHealthService");
const SearchService_1 = require("../services/SearchService");
const UserRiskProfileService_1 = require("../services/UserRiskProfileService");
const asyncHandler_1 = require("../utils/asyncHandler");
const auth_1 = require("../middleware/auth");
const validate_1 = require("../middleware/validate");
const schemas_1 = require("../utils/schemas");
const env_1 = require("../config/env");
const transactionRepository = new TransactionRepository_1.TransactionRepository();
const caseRepository = new CaseRepository_1.CaseRepository();
const auditLogRepository = new AuditLogRepository_1.AuditLogRepository();
const modelMetricRepository = new ModelMetricRepository_1.ModelMetricRepository();
const systemSettingRepository = new SystemSettingRepository_1.SystemSettingRepository();
const userRiskProfileRepository = new UserRiskProfileRepository_1.UserRiskProfileRepository();
const eventBusService = new EventBusService_1.EventBusService();
const fraudAlertRepository = new FraudAlertRepository_1.FraudAlertRepository();
const userDeviceRepository = new UserDeviceRepository_1.UserDeviceRepository();
const fraudExplanationRepository = new FraudExplanationRepository_1.FraudExplanationRepository();
const geoService = new GeoService_1.GeoService();
const auditService = new AuditService_1.AuditService(auditLogRepository);
const modelMetricsService = new ModelMetricsService_1.ModelMetricsService(modelMetricRepository, transactionRepository);
const settingsService = new SettingsService_1.SettingsService(systemSettingRepository, auditService);
const userRiskProfileService = new UserRiskProfileService_1.UserRiskProfileService(transactionRepository, userRiskProfileRepository);
const ruleEngineService = new RuleEngineService_1.RuleEngineService(transactionRepository, userRiskProfileService, settingsService);
const mlServiceClient = new MlServiceClient_1.MlServiceClient();
const fraudScoringService = new FraudScoringService_1.FraudScoringService(ruleEngineService, mlServiceClient, settingsService);
const autonomousResponseService = new AutonomousResponseService_1.AutonomousResponseService(fraudAlertRepository, eventBusService, settingsService, auditService, env_1.env.AUTONOMOUS_ALERT_THRESHOLD);
const deviceFingerprintService = new DeviceFingerprintService_1.DeviceFingerprintService(userDeviceRepository);
const fraudExplanationService = new FraudExplanationService_1.FraudExplanationService(fraudExplanationRepository);
const transactionService = new TransactionService_1.TransactionService(transactionRepository, fraudScoringService, eventBusService, autonomousResponseService, deviceFingerprintService, fraudExplanationService, geoService, auditService, modelMetricsService);
const transactionController = new TransactionController_1.TransactionController(transactionService);
const simulationService = new SimulationService_1.SimulationService(transactionService, eventBusService, settingsService);
const simulationController = new SimulationController_1.SimulationController(simulationService);
const monitoringController = new MonitoringController_1.MonitoringController(fraudAlertRepository, userDeviceRepository, fraudExplanationService, transactionRepository, caseRepository);
const caseService = new CaseService_1.CaseService(caseRepository, auditService);
const caseController = new CaseController_1.CaseController(caseService);
const auditController = new AuditController_1.AuditController(auditService);
const systemHealthService = new SystemHealthService_1.SystemHealthService(mlServiceClient);
const systemController = new SystemController_1.SystemController(mlServiceClient, systemHealthService);
const modelController = new ModelController_1.ModelController(mlServiceClient, modelMetricsService);
const settingsController = new SettingsController_1.SettingsController(settingsService);
const searchService = new SearchService_1.SearchService();
const searchController = new SearchController_1.SearchController(searchService);
const userRepository = new UserRepository_1.UserRepository();
const authService = new AuthService_1.AuthService(userRepository, auditService);
const authController = new AuthController_1.AuthController(authService);
exports.router = (0, express_1.Router)();
exports.router.post('/api/v1/auth/register', (0, validate_1.validate)(schemas_1.registerSchema), (0, asyncHandler_1.asyncHandler)(authController.register));
exports.router.post('/api/v1/auth/login', (0, validate_1.validate)(schemas_1.loginSchema), (0, asyncHandler_1.asyncHandler)(authController.login));
exports.router.post('/api/v1/transactions', auth_1.authMiddleware, (0, auth_1.roleMiddleware)(['admin', 'analyst']), (0, validate_1.validate)(schemas_1.createTransactionSchema), (0, asyncHandler_1.asyncHandler)(transactionController.create));
exports.router.get('/api/v1/transactions', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(transactionController.list));
exports.router.get('/api/v1/transactions/query', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(transactionController.query));
exports.router.get('/api/v1/transactions/:transactionId', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(transactionController.byId));
exports.router.get('/api/v1/transactions/stats', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(transactionController.stats));
exports.router.post('/api/v1/simulation/start', auth_1.authMiddleware, (0, auth_1.roleMiddleware)(['admin']), (0, validate_1.validate)(schemas_1.simulationSchema), (0, asyncHandler_1.asyncHandler)(simulationController.start));
exports.router.get('/api/v1/alerts', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(monitoringController.alerts));
exports.router.get('/api/v1/alerts/:alertId', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(monitoringController.alertDetails));
exports.router.get('/api/v1/devices', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(monitoringController.devices));
exports.router.get('/api/v1/explanations', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(monitoringController.explanations));
exports.router.post('/api/v1/cases', auth_1.authMiddleware, (0, validate_1.validate)(schemas_1.createCaseSchema), (0, asyncHandler_1.asyncHandler)(caseController.create));
exports.router.get('/api/v1/cases', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(caseController.list));
exports.router.patch('/api/v1/cases/:id', auth_1.authMiddleware, (0, validate_1.validate)(schemas_1.updateCaseSchema), (0, asyncHandler_1.asyncHandler)(caseController.update));
exports.router.get('/api/v1/audit', auth_1.authMiddleware, (0, auth_1.roleMiddleware)(['admin', 'analyst']), (0, asyncHandler_1.asyncHandler)(auditController.list));
exports.router.get('/api/v1/search', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(searchController.query));
exports.router.get('/api/v1/model/info', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(modelController.info));
exports.router.get('/api/v1/model/health', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(modelController.health));
exports.router.get('/api/v1/system/ml-status', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(systemController.mlStatus));
exports.router.get('/api/v1/system/health', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(systemController.health));
exports.router.get('/api/v1/settings', auth_1.authMiddleware, (0, asyncHandler_1.asyncHandler)(settingsController.get));
exports.router.patch('/api/v1/settings', auth_1.authMiddleware, (0, auth_1.roleMiddleware)(['admin']), (0, validate_1.validate)(schemas_1.updateSettingsSchema), (0, asyncHandler_1.asyncHandler)(settingsController.update));
